<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Orders Management - MeatChain Pro</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="../assests/Style/style.css">
</head>
<body style="background-color: #f8f9fa;">

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark px-4">
  <a class="navbar-brand fw-bold" href="#" id="brandLink"><i class="bi bi-truck me-2"></i>MeatChain Pro</a>
  <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
    <span class="navbar-toggler-icon"></span>
  </button>
  <div class="collapse navbar-collapse" id="navbarNav">
    <ul class="navbar-nav me-auto" id="navItems">
      <!-- Navigation items will be loaded based on user role -->
    </ul>
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link" href="login.html"><i class="bi bi-box-arrow-right me-2"></i>Logout</a>
      </li>
    </ul>
  </div>
</nav>

<div class="container-fluid mt-4">
  <!-- Header Section -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2 class="text-success fw-bold mb-0"><i class="bi bi-clipboard-check me-2"></i>Orders Management</h2>
      <p class="text-muted mb-0" id="headerDesc">Manage your orders and cart</p>
    </div>
    <div id="headerActions">
      <!-- Actions will be loaded based on user role -->
    </div>
  </div>

  <!-- Cart Section (for customers) -->
  <div id="cartSection" class="mb-4" style="display: none;">
    <div class="card border-0 shadow-sm">
      <div class="card-header bg-warning text-dark">
        <h5 class="mb-0"><i class="bi bi-cart me-2"></i>Shopping Cart</h5>
      </div>
      <div class="card-body">
        <div id="cartItems">
          <!-- Cart items will be loaded here -->
        </div>
        <div class="d-flex justify-content-between align-items-center mt-3">
          <div>
            <strong>Total: <span id="cartTotal">$0.00</span></strong>
          </div>
          <div>
            <button class="btn btn-outline-secondary me-2" onclick="clearCart()">Clear Cart</button>
            <button class="btn btn-success" onclick="checkoutCart()" id="checkoutBtn" disabled>
              <i class="bi bi-check-circle me-1"></i>Checkout
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Orders Statistics -->
  <div class="row mb-4" id="statsSection">
    <!-- Stats cards will be loaded here -->
  </div>

  <!-- Search and Filter Section -->
  <div class="search-filters">
    <div class="row">
      <div class="col-md-4">
        <div class="input-group">
          <span class="input-group-text"><i class="bi bi-search"></i></span>
          <input type="text" id="searchInput" class="form-control" placeholder="Search orders...">
        </div>
      </div>
      <div class="col-md-3">
        <select id="statusFilter" class="form-select">
          <option value="">All Status</option>
          <option value="Pending">Pending</option>
          <option value="Processing">Processing</option>
          <option value="Shipped">Shipped</option>
          <option value="Delivered">Delivered</option>
          <option value="Cancelled">Cancelled</option>
        </select>
      </div>
      <div class="col-md-3">
        <input type="date" id="dateFilter" class="form-control">
      </div>
      <div class="col-md-2">
        <button class="btn btn-outline-success w-100" onclick="clearFilters()">
          <i class="bi bi-arrow-clockwise me-1"></i>Clear
        </button>
      </div>
    </div>
  </div>

  <!-- Orders Table -->
  <div class="table-responsive">
    <table class="table table-hover align-middle" id="ordersTable">
      <thead class="table-success">
        <tr>
          <th>Order ID</th>
          <th>Customer</th>
          <th>Date</th>
          <th>Items</th>
          <th>Total</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="ordersTableBody">
        <!-- Orders will be loaded here -->
      </tbody>
    </table>
  </div>
</div>

<!-- Order Details Modal -->
<div class="modal fade" id="orderDetailsModal" tabindex="-1" aria-labelledby="orderDetailsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title" id="orderDetailsModalLabel">
          <i class="bi bi-receipt me-2"></i>Order Details
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="orderDetailsContent">
        <!-- Order details will be loaded here -->
      </div>
      <div class="modal-footer" id="orderDetailsActions">
        <!-- Actions will be loaded based on user role -->
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>

let orders = [];
let currentUser = null;
let isAdmin = false;

// Initialize the page
document.addEventListener('DOMContentLoaded', function() {
    setupBrandNavigation();
    loadUserInfo();
    setupUserInterface();
    loadOrders();
    loadCart();
    setupEventListeners();
});


function setupBrandNavigation() {
    const user = JSON.parse(localStorage.getItem('loggedInUser'));
    const brandLink = document.getElementById('brandLink');
    
    if (user) {
        // User is logged in, redirect to appropriate dashboard
        if (user.role === 'admin') {
            brandLink.href = 'admin_dashboard.html';
        } else if (user.role === 'customer') {
            brandLink.href = 'customer_dashboard.html';
        }
    } else {
        // User is not logged in, redirect to home page
        brandLink.href = '../index.html';
    }
}

// Load user information
function loadUserInfo() {
    currentUser = JSON.parse(localStorage.getItem('loggedInUser'));
    if (currentUser) {
        isAdmin = currentUser.role === 'admin';
    }
}

// Setup user interface based on role
function setupUserInterface() {
    const navItems = document.getElementById('navItems');
    const headerDesc = document.getElementById('headerDesc');
    const headerActions = document.getElementById('headerActions');
    const cartSection = document.getElementById('cartSection');
    
    if (isAdmin) {
        // Admin navigation
        navItems.innerHTML = `
            <li class="nav-item"><a class="nav-link" href="admin_dashboard.html">Dashboard</a></li>
            <li class="nav-item"><a class="nav-link" href="inventory.html">Inventory</a></li>
            <li class="nav-item"><a class="nav-link" href="suppliers.html">Suppliers</a></li>
            <li class="nav-item"><a class="nav-link active" href="orders.html">Orders</a></li>
            <li class="nav-item"><a class="nav-link" href="analytics.html">Analytics</a></li>
        `;
        headerDesc.textContent = 'Manage all customer orders and track deliveries';
        cartSection.style.display = 'none';
    } else {
        // Customer navigation
        navItems.innerHTML = `
            <li class="nav-item"><a class="nav-link" href="customer_dashboard.html">Dashboard</a></li>
            <li class="nav-item"><a class="nav-link" href="inventory_view.html">Browse Products</a></li>
            <li class="nav-item"><a class="nav-link active" href="orders.html">My Orders</a></li>
        `;
        headerDesc.textContent = 'Manage your cart and view order history';
        cartSection.style.display = 'block';
        headerActions.innerHTML = `
            <a href="inventory_view.html" class="btn btn-outline-success">
                <i class="bi bi-plus-circle me-1"></i>Add Products
            </a>
        `;
    }
    
    loadStats();
}

// Load statistics
function loadStats() {
    const statsSection = document.getElementById('statsSection');
    
    if (isAdmin) {
        // Admin stats
        const totalOrders = orders.length;
        const pendingOrders = orders.filter(o => o.status === 'Pending' || o.status === 'Processing').length;
        const totalRevenue = orders.reduce((sum, order) => sum + order.total, 0);
        const deliveredOrders = orders.filter(o => o.status === 'Delivered').length;
        
        statsSection.innerHTML = `
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col">
                                <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Total Orders</div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800">${totalOrders}</div>
                            </div>
                            <div class="col-auto">
                                <i class="bi bi-clipboard-check display-4 text-primary"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col">
                                <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Pending Orders</div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800">${pendingOrders}</div>
                            </div>
                            <div class="col-auto">
                                <i class="bi bi-hourglass-split display-4 text-warning"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col">
                                <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Total Revenue</div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800">$${totalRevenue.toFixed(2)}</div>
                            </div>
                            <div class="col-auto">
                                <i class="bi bi-currency-dollar display-4 text-success"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col">
                                <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Delivered</div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800">${deliveredOrders}</div>
                            </div>
                            <div class="col-auto">
                                <i class="bi bi-check-circle display-4 text-info"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    } else {
        // Customer stats
        const userOrders = orders.filter(o => o.customerId === currentUser.userId);
        const totalOrders = userOrders.length;
        const pendingOrders = userOrders.filter(o => o.status === 'Pending' || o.status === 'Processing').length;
        const totalSpent = userOrders.reduce((sum, order) => sum + order.total, 0);
        
        statsSection.innerHTML = `
            <div class="col-md-4 mb-4">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body text-center">
                        <i class="bi bi-clipboard-check display-4 text-primary mb-2"></i>
                        <h5 class="card-title">Total Orders</h5>
                        <h3 class="text-primary">${totalOrders}</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-4">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body text-center">
                        <i class="bi bi-hourglass-split display-4 text-warning mb-2"></i>
                        <h5 class="card-title">Pending Orders</h5>
                        <h3 class="text-warning">${pendingOrders}</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-4">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body text-center">
                        <i class="bi bi-currency-dollar display-4 text-success mb-2"></i>
                        <h5 class="card-title">Total Spent</h5>
                        <h3 class="text-success">$${totalSpent.toFixed(2)}</h3>
                    </div>
                </div>
            </div>
        `;
    }
}

// Load orders
function loadOrders() {
    // Load from localStorage or create sample data
    orders = JSON.parse(localStorage.getItem('customerOrders')) || [];
    
    // Create sample orders if none exist
    if (orders.length === 0) {
        orders = [
            {
                id: 'ORD001',
                customerId: 'customer',
                customerName: 'Customer User',
                date: '2025-07-30',
                items: [
                    { productId: 'MT001', productName: 'Premium Beef Ribeye', quantity: 2.5, unitPrice: 35.99, total: 89.98 }
                ],
                total: 89.98,
                status: 'Delivered'
            },
            {
                id: 'ORD002',
                customerId: 'demo',
                customerName: 'Demo Customer',
                date: '2025-07-31',
                items: [
                    { productId: 'MT002', productName: 'Chicken Breast', quantity: 5.0, unitPrice: 12.99, total: 64.95 },
                    { productId: 'MT004', productName: 'Pork Tenderloin', quantity: 1.5, unitPrice: 18.75, total: 28.13 }
                ],
                total: 93.08,
                status: 'Processing'
            }
        ];
        localStorage.setItem('customerOrders', JSON.stringify(orders));
    }
    
    loadOrdersTable();
    loadStats();
}

// Load orders table
function loadOrdersTable() {
    const tableBody = document.getElementById('ordersTableBody');
    tableBody.innerHTML = '';
    
    let displayOrders = orders;
    
    // Filter orders for customers
    if (!isAdmin && currentUser) {
        displayOrders = orders.filter(order => order.customerId === currentUser.userId);
    }
    
    displayOrders.forEach((order, index) => {
        const row = createOrderRow(order, index);
        tableBody.appendChild(row);
    });
}

// Create order row
function createOrderRow(order, index) {
    const row = document.createElement('tr');
    row.className = 'fade-in';
    
    const statusBadge = getStatusBadge(order.status);
    const itemsCount = order.items ? order.items.length : 0;
    
    row.innerHTML = `
        <td><strong>${order.id}</strong></td>
        <td>${isAdmin ? order.customerName : 'You'}</td>
        <td>${formatDate(order.date)}</td>
        <td>${itemsCount} items</td>
        <td>$${order.total.toFixed(2)}</td>
        <td>${statusBadge}</td>
        <td>
            <div class="btn-group" role="group">
                <button class="btn btn-sm btn-outline-info" onclick="viewOrderDetails('${order.id}')" data-bs-toggle="tooltip" title="View Details">
                    <i class="bi bi-eye"></i>
                </button>
                ${isAdmin ? `
                    <button class="btn btn-sm btn-outline-warning" onclick="updateOrderStatus('${order.id}')" data-bs-toggle="tooltip" title="Update Status">
                        <i class="bi bi-pencil"></i>
                    </button>
                ` : ''}
                ${(isAdmin || order.status === 'Pending') ? `
                    <button class="btn btn-sm btn-outline-danger" onclick="cancelOrder('${order.id}')" data-bs-toggle="tooltip" title="Cancel Order">
                        <i class="bi bi-x-circle"></i>
                    </button>
                ` : ''}
            </div>
        </td>
    `;
    
    return row;
}

// Get status badge
function getStatusBadge(status) {
    const badges = {
        'Pending': '<span class="badge bg-warning">Pending</span>',
        'Processing': '<span class="badge bg-info">Processing</span>',
        'Shipped': '<span class="badge bg-primary">Shipped</span>',
        'Delivered': '<span class="badge bg-success">Delivered</span>',
        'Cancelled': '<span class="badge bg-danger">Cancelled</span>'
    };
    return badges[status] || '<span class="badge bg-secondary">Unknown</span>';
}

// Format date
function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'short', 
        day: 'numeric' 
    });
}

// Load cart
function loadCart() {
    if (isAdmin) return; // Admins don't have carts
    
    const cart = JSON.parse(localStorage.getItem('customerCart')) || [];
    const cartItems = document.getElementById('cartItems');
    const cartTotal = document.getElementById('cartTotal');
    const checkoutBtn = document.getElementById('checkoutBtn');
    
    if (cart.length === 0) {
        cartItems.innerHTML = `
            <div class="text-center text-muted py-3">
                <i class="bi bi-cart display-4 mb-2"></i>
                <p class="mb-0">Your cart is empty</p>
                <small>Add products to your cart to place an order</small>
            </div>
        `;
        cartTotal.textContent = '$0.00';
        checkoutBtn.disabled = true;
        return;
    }
    
    let total = 0;
    cartItems.innerHTML = cart.map((item, index) => {
        total += item.total;
        return `
            <div class="d-flex justify-content-between align-items-center border-bottom py-2">
                <div>
                    <strong>${item.productName}</strong><br>
                    <small class="text-muted">${item.quantity}kg × $${item.unitPrice}</small>
                </div>
                <div class="d-flex align-items-center">
                    <span class="me-3"><strong>$${item.total.toFixed(2)}</strong></span>
                    <button class="btn btn-sm btn-outline-danger" onclick="removeFromCart(${index})">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </div>
        `;
    }).join('');
    
    cartTotal.textContent = '$' + total.toFixed(2);
    checkoutBtn.disabled = false;
}

// Remove from cart
function removeFromCart(index) {
    let cart = JSON.parse(localStorage.getItem('customerCart')) || [];
    cart.splice(index, 1);
    localStorage.setItem('customerCart', JSON.stringify(cart));
    loadCart();
    showNotification('Item removed from cart', 'info');
}

// Clear cart
function clearCart() {
    if (confirm('Are you sure you want to clear your cart?')) {
        localStorage.removeItem('customerCart');
        loadCart();
        showNotification('Cart cleared', 'info');
    }
}

// Checkout cart
function checkoutCart() {
    const cart = JSON.parse(localStorage.getItem('customerCart')) || [];
    if (cart.length === 0) return;
    
    const newOrder = {
        id: 'ORD' + String(Date.now()).slice(-6),
        customerId: currentUser.userId,
        customerName: currentUser.name,
        date: new Date().toISOString().split('T')[0],
        items: cart,
        total: cart.reduce((sum, item) => sum + item.total, 0),
        status: 'Pending'
    };
    
    orders.push(newOrder);
    localStorage.setItem('customerOrders', JSON.stringify(orders));
    localStorage.removeItem('customerCart');
    
    loadOrders();
    loadCart();
    
    showNotification('Order placed successfully!', 'success');
}

// View order details
function viewOrderDetails(orderId) {
    const order = orders.find(o => o.id === orderId);
    if (!order) return;
    
    const content = document.getElementById('orderDetailsContent');
    const actions = document.getElementById('orderDetailsActions');
    
    content.innerHTML = `
        <div class="row mb-3">
            <div class="col-md-6">
                <strong>Order ID:</strong> ${order.id}<br>
                <strong>Customer:</strong> ${order.customerName}<br>
                <strong>Date:</strong> ${formatDate(order.date)}
            </div>
            <div class="col-md-6 text-end">
                <strong>Status:</strong> ${getStatusBadge(order.status)}<br>
                <strong>Total:</strong> <span class="h5 text-success">$${order.total.toFixed(2)}</span>
            </div>
        </div>
        <hr>
        <h6>Order Items:</h6>
        <div class="table-responsive">
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>Product</th>
                        <th>Quantity</th>
                        <th>Unit Price</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody>
                    ${order.items.map(item => `
                        <tr>
                            <td>${item.productName}</td>
                            <td>${item.quantity}kg</td>
                            <td>$${item.unitPrice}</td>
                            <td>$${item.total.toFixed(2)}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
    
    actions.innerHTML = `
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        ${isAdmin && order.status !== 'Delivered' && order.status !== 'Cancelled' ? `
            <button type="button" class="btn btn-warning" onclick="updateOrderStatusModal('${order.id}')">Update Status</button>
        ` : ''}
    `;
    
    const modal = new bootstrap.Modal(document.getElementById('orderDetailsModal'));
    modal.show();
}

// Update order status (admin only)
function updateOrderStatus(orderId) {
    if (!isAdmin) return;
    
    const order = orders.find(o => o.id === orderId);
    if (!order) return;
    
    const statuses = ['Pending', 'Processing', 'Shipped', 'Delivered', 'Cancelled'];
    const currentIndex = statuses.indexOf(order.status);
    const nextStatus = statuses[Math.min(currentIndex + 1, statuses.length - 1)];
    
    if (confirm(`Update order ${orderId} status to "${nextStatus}"?`)) {
        order.status = nextStatus;
        localStorage.setItem('customerOrders', JSON.stringify(orders));
        loadOrdersTable();
        loadStats();
        showNotification(`Order ${orderId} updated to ${nextStatus}`, 'success');
    }
}

// Cancel order
function cancelOrder(orderId) {
    const order = orders.find(o => o.id === orderId);
    if (!order) return;
    
    if (!isAdmin && order.customerId !== currentUser.userId) {
        showNotification('You can only cancel your own orders', 'danger');
        return;
    }
    
    if (order.status === 'Delivered' || order.status === 'Cancelled') {
        showNotification('Cannot cancel this order', 'warning');
        return;
    }
    
    if (confirm(`Are you sure you want to cancel order ${orderId}?`)) {
        order.status = 'Cancelled';
        localStorage.setItem('customerOrders', JSON.stringify(orders));
        loadOrdersTable();
        loadStats();
        showNotification(`Order ${orderId} cancelled`, 'info');
    }
}

// Setup event listeners
function setupEventListeners() {
    document.getElementById('searchInput').addEventListener('input', filterOrders);
    document.getElementById('statusFilter').addEventListener('change', filterOrders);
    document.getElementById('dateFilter').addEventListener('change', filterOrders);
}

// Filter orders
function filterOrders() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const statusFilter = document.getElementById('statusFilter').value;
    const dateFilter = document.getElementById('dateFilter').value;
    
    let displayOrders = orders;
    
    // Filter by user role
    if (!isAdmin && currentUser) {
        displayOrders = orders.filter(order => order.customerId === currentUser.userId);
    }
    
    // Apply filters
    const filteredOrders = displayOrders.filter(order => {
        const matchesSearch = order.id.toLowerCase().includes(searchTerm) || 
                            order.customerName.toLowerCase().includes(searchTerm);
        const matchesStatus = !statusFilter || order.status === statusFilter;
        const matchesDate = !dateFilter || order.date === dateFilter;
        
        return matchesSearch && matchesStatus && matchesDate;
    });
    
    const tableBody = document.getElementById('ordersTableBody');
    tableBody.innerHTML = '';
    
    filteredOrders.forEach((order, index) => {
        const row = createOrderRow(order, index);
        tableBody.appendChild(row);
    });
}

// Clear filters
function clearFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('statusFilter').value = '';
    document.getElementById('dateFilter').value = '';
    loadOrdersTable();
}

// Show notification
function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 5000);
}
</script>

</body>
</html>
